<!DOCTYPE html>
<html>

<head>
</head>

<body>
  <div id="main" class="language-klipse">
(ns pou.user
  (:require [goog.dom :as gdom]
            [klipse.plugin :as klp]))

(def j js/applied-science.js-interop)
    
(def pou (atom {:params (or (js/klipse.utils.url-parameters) {})
                :editors {:main {:type :cljs
                                 :cm (aget js/klipse-editors 0)
                                 :res (aget js/klipse-results 0)}}}))

(defn pou-add [& {:keys [mode attrs snippet klipsettings]}]
  (let [div (gdom/createDom "div" (clj->js attrs) (gdom/createTextNode (str snippet)))]
    (gdom/insertSiblingAfter div js/klipse-container)
    (klp/klipsify div (merge {} klipsettings) mode)))

(defn cm [k method & args]
  (j.apply (-> @pou :editors k :cm) method (clj->js args)))
    
(defn load-gist [id file callback]
  (-> (str "https://api.github.com/gists/" id) js/fetch
    (.then (fn [r]
       (.then (.json r)
              (fn [json]
                (callback (-> (js->clj json :keywordize-keys true) :files ((keyword file)) :content))))))))
    
(defn eval-gist [& {:keys [id file editor append-code clear-code] :or {editor :main append-code ""}}]
  (load-gist id file #(cm editor :setValue (str % "\n" append-code
                                                (when clear-code (str "\n(pou.user/cm " editor " :setValue \"" clear-code "\")"))))))

(defn eval-gist-loop [f & r] 
  (eval-gist :id (:id f) :file (:file f) :append-code (if (not (empty? (rest r))) `(apply eval-gist-loop ~r) 
                                                                                  `(apply eval-gist (mapcat seq ~(first r))))))

(let [{:keys [params editors]} @pou] (if-let [p (params :p)] (cm :main :setValue (js/atob p)) @pou))
    
  </div>
  <link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/app.klipse.tech/css/codemirror.css">
  <script>
  window.klipse_settings = {
      selector: '.language-klipse'
  };
  </script>
  <script src="https://storage.googleapis.com/app.klipse.tech/plugin/js/klipse_plugin.js"></script>
</body>

</html>
